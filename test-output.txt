
> qwork2026@1.0.0 pretest C:\apps\QWork
> dotenv -e .env.test --override -- node scripts/checks/validate-test-isolation.js && dotenv -e .env.test --override -- node scripts/checks/ensure-test-env.js && dotenv -e .env.test --override -- node scripts/checks/no-dev-db-in-tests.cjs && dotenv -e .env.test --override -- node scripts/checks/fix-duplicated-fk.cjs && dotenv -e .env.test --override -- node scripts/checks/fix-detectar-anomalias.cjs


­ƒöì Validando isolamento de ambientes...

Ô£à TEST_DATABASE_URL: nr-bps_db_test
ÔÜá´©Å  AVISO: LOCAL_DATABASE_URL aponta para banco de teste
   Banco: nr-bps_db_test
   LOCAL_DATABASE_URL deve apontar para nr-bps_db (desenvolvimento)

ÔÜá´©Å  AVISO: JEST_WORKER_ID n├úo definida (executando fora do Jest?)


======================================================================

Ô£à VALIDA├ç├âO PASSOU: Ambiente de teste est├í isolado e seguro
   Banco de testes: nr-bps_db_test
   Banco de desenvolvimento protegido: nr-bps_db
   Pol├¡tica: TESTING-POLICY.md

Ô£à TEST_DATABASE_URL est├í definida e aponta para um banco de teste: nr-bps_db_test
Ô£à Nenhuma refer├¬ncia direta a nr-bps_db encontrada em __tests__.
Verificando e removendo FK duplicada lotes_avaliacao_liberado_por_fkey1 (se existir)...
Corre├º├úo aplicada (se necess├íria).
Aplicando corre├º├úo da fun├º├úo detectar_anomalias_indice...
Corre├º├úo aplicada com sucesso.

> qwork2026@1.0.0 test C:\apps\QWork
> dotenv -e .env.test --override -- jest "__tests__/lib/pdf/timezone-helper.test.ts" "--no-coverage"

[jest.config] SKIP_GLOBAL_JEST_SETUP=1 ÔÇö globalSetup/globalTeardown removidos
RBAC seed applied to test database
FAIL __tests__/lib/pdf/timezone-helper.test.ts
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (0) from .env.test -- tip: ÔÜÖ´©Å  suppress all logs with { quiet: true }

      at _log (node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒøí´©Å [jest.setup] Removendo DATABASE_URL de produ├º├úo do ambiente de testes

      at Object.<anonymous> (__tests__/config/jest.setup.js:124:17)

    console.log
      ­ƒøí´©Å [jest.setup] Prote├º├úo do banco de testes ativada - usando: nr-bps_db_test

      at Object.<anonymous> (__tests__/config/jest.setup.js:138:13)

  ÔùÅ Timezone Helper - Corre├º├úo de +3 Horas em PROD ÔÇ║ Tratamento de datas lim├¡trofes ÔÇ║ deve subtrair 3 horas mesmo para horas < 3 (resultado em horas negativas do dia anterior)

    expect(received).toContain(expected) // indexOf

    Expected substring: "23:00:00"
    Received string:    "16/02/2026, 20:00:00"

      140 |       const resultado = formatarDataCorrigida(corrigida);
      141 |       expect(resultado).toContain('16/02');
    > 142 |       expect(resultado).toContain('23:00:00');
          |                         ^
      143 |     });
      144 |
      145 |     it('deve preservar data corretamente em meia-noite', () => {

      at Object.toContain (__tests__/lib/pdf/timezone-helper.test.ts:142:25)

  ÔùÅ Timezone Helper - Corre├º├úo de +3 Horas em PROD ÔÇ║ Tratamento de datas lim├¡trofes ÔÇ║ deve preservar data corretamente em meia-noite

    expect(received).toContain(expected) // indexOf

    Expected substring: "21:00:00"
    Received string:    "16/02/2026, 18:00:00"

      151 |       const resultado = formatarDataCorrigida(corrigida);
      152 |       expect(resultado).toContain('16/02');
    > 153 |       expect(resultado).toContain('21:00:00');
          |                         ^
      154 |     });
      155 |   });
      156 | });

      at Object.toContain (__tests__/lib/pdf/timezone-helper.test.ts:153:25)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 11 passed, 13 total
Snapshots:   0 total
Time:        1.935 s
Ran all test suites matching __tests__/lib/pdf/timezone-helper.test.ts.
ÔÇëELIFECYCLEÔÇë Test failed. See above for more details.
