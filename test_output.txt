
> qwork2026@1.0.0 pretest C:\apps\QWork
> dotenv -e .env.test --override -- node scripts/checks/validate-test-isolation.js && dotenv -e .env.test --override -- node scripts/checks/ensure-test-env.js && dotenv -e .env.test --override -- node scripts/checks/no-dev-db-in-tests.cjs && dotenv -e .env.test --override -- node scripts/checks/fix-duplicated-fk.cjs && dotenv -e .env.test --override -- node scripts/checks/fix-detectar-anomalias.cjs


­ƒöì Validando isolamento de ambientes...

Ô£à TEST_DATABASE_URL: nr-bps_db_test
ÔÜá´©Å  AVISO: LOCAL_DATABASE_URL aponta para banco de teste
   Banco: nr-bps_db_test
   LOCAL_DATABASE_URL deve apontar para nr-bps_db (desenvolvimento)

ÔÜá´©Å  AVISO: JEST_WORKER_ID n├úo definida (executando fora do Jest?)


======================================================================

Ô£à VALIDA├ç├âO PASSOU: Ambiente de teste est├í isolado e seguro
   Banco de testes: nr-bps_db_test
   Banco de desenvolvimento protegido: nr-bps_db
   Pol├¡tica: TESTING-POLICY.md

Ô£à TEST_DATABASE_URL est├í definida e aponta para um banco de teste: nr-bps_db_test
Ô£à Nenhuma refer├¬ncia direta a nr-bps_db encontrada em __tests__.
Verificando e removendo FK duplicada lotes_avaliacao_liberado_por_fkey1 (se existir)...
Corre├º├úo aplicada (se necess├íria).
Aplicando corre├º├úo da fun├º├úo detectar_anomalias_indice...
Corre├º├úo aplicada com sucesso.

> qwork2026@1.0.0 test C:\apps\QWork
> dotenv -e .env.test --override -- jest "__tests__/api/entidade/laudos-download-backblaze-proxy.test.ts" "--passWithNoTests"

[jest.config] SKIP_GLOBAL_JEST_SETUP=1 ÔÇö globalSetup/globalTeardown removidos
RBAC seed applied to test database
FAIL __tests__/api/entidade/laudos-download-backblaze-proxy.test.ts
  ÔùÅ Console

    console.log
      [dotenv@17.2.3] injecting env (0) from .env.test -- tip: ÔÜÖ´©Å  specify custom .env file path with { path: '/custom/path/.env' }

      at _log (node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒøí´©Å [jest.setup] Removendo DATABASE_URL de produ├º├úo do ambiente de testes

      at Object.<anonymous> (__tests__/config/jest.setup.js:124:17)

    console.log
      ­ƒøí´©Å [jest.setup] Prote├º├úo do banco de testes ativada - usando: nr-bps_db_test

      at Object.<anonymous> (__tests__/config/jest.setup.js:138:13)

    console.log
      [dotenv@17.2.3] injecting env (12) from .env.local -- tip: ­ƒöæ add access controls to secrets: https://dotenvx.com/ops

      at _log (node_modules/.pnpm/dotenv@17.2.3/node_modules/dotenv/lib/main.js:142:11)

    console.log
      ­ƒöî [lib/db.ts] Conectado ao banco: nr-bps_db_test @ localhost (ambiente: test)

      at Object.log (lib/db.ts:664:15)

    console.log
      [BACKBLAZE] Arquivo remoto encontrado no banco: laudos/lote-1008/laudo-123.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:82:13)

    console.log
      [BACKBLAZE] Provider: b2, endpoint: https://s3.us-east-005.backblazeb2.com, bucket: laudos-qwork, region: us-east-005

      at log (lib/storage/backblaze-client.ts:147:11)

    console.log
      [BACKBLAZE] Key source: BACKBLAZE_KEY_ID=0052a814..., AppKey source: BACKBLAZE_APPLICATION_KEY=K005FuY8...

      at log (lib/storage/backblaze-client.ts:150:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Gerando URL presigned para: laudos/lote-1008/laudo-123.pdf

      at log (lib/storage/backblaze-client.ts:402:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Config: endpoint=https://s3.us-east-005.backblazeb2.com, bucket=laudos-qwork, region=us-east-005

      at log (lib/storage/backblaze-client.ts:403:11)

    console.log
      [BACKBLAZE:getPresignedUrl] URL gerada: https://s3.us-east-005.backblazeb2.com/laudos-qwork/laudos/lote-1008/laudo-123.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Am...

      at log (lib/storage/backblaze-client.ts:426:11)

    console.log
      [BACKBLAZE] Presigned URL gerada com sucesso para: laudos/lote-1008/laudo-123.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:90:15)

    console.log
      [BACKBLAZE] Fazendo download server-side do PDF...

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:96:15)

    console.log
      [BACKBLAZE] PDF baixado com sucesso (16 bytes)

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:110:15)

    console.log
      [BACKBLAZE] Arquivo remoto encontrado no banco: laudos/lote-1008/laudo-456.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:82:13)

    console.log
      [BACKBLAZE] Provider: b2, endpoint: https://s3.us-east-005.backblazeb2.com, bucket: laudos-qwork, region: us-east-005

      at log (lib/storage/backblaze-client.ts:147:11)

    console.log
      [BACKBLAZE] Key source: BACKBLAZE_KEY_ID=0052a814..., AppKey source: BACKBLAZE_APPLICATION_KEY=K005FuY8...

      at log (lib/storage/backblaze-client.ts:150:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Gerando URL presigned para: laudos/lote-1008/laudo-456.pdf

      at log (lib/storage/backblaze-client.ts:402:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Config: endpoint=https://s3.us-east-005.backblazeb2.com, bucket=laudos-qwork, region=us-east-005

      at log (lib/storage/backblaze-client.ts:403:11)

    console.log
      [BACKBLAZE:getPresignedUrl] URL gerada: https://s3.us-east-005.backblazeb2.com/laudos-qwork/laudos/lote-1008/laudo-456.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Am...

      at log (lib/storage/backblaze-client.ts:426:11)

    console.log
      [BACKBLAZE] Presigned URL gerada com sucesso para: laudos/lote-1008/laudo-456.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:90:15)

    console.log
      [BACKBLAZE] Fazendo download server-side do PDF...

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:96:15)

    console.log
      [BACKBLAZE] PDF baixado com sucesso (13 bytes)

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:110:15)

    console.log
      [BACKBLAZE] Arquivo remoto encontrado no banco: laudos/lote-1008/laudo-789.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:82:13)

    console.log
      [BACKBLAZE] Provider: b2, endpoint: https://s3.us-east-005.backblazeb2.com, bucket: laudos-qwork, region: us-east-005

      at log (lib/storage/backblaze-client.ts:147:11)

    console.log
      [BACKBLAZE] Key source: BACKBLAZE_KEY_ID=0052a814..., AppKey source: BACKBLAZE_APPLICATION_KEY=K005FuY8...

      at log (lib/storage/backblaze-client.ts:150:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Gerando URL presigned para: laudos/lote-1008/laudo-789.pdf

      at log (lib/storage/backblaze-client.ts:402:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Config: endpoint=https://s3.us-east-005.backblazeb2.com, bucket=laudos-qwork, region=us-east-005

      at log (lib/storage/backblaze-client.ts:403:11)

    console.log
      [BACKBLAZE:getPresignedUrl] URL gerada: https://s3.us-east-005.backblazeb2.com/laudos-qwork/laudos/lote-1008/laudo-789.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Am...

      at log (lib/storage/backblaze-client.ts:426:11)

    console.log
      [BACKBLAZE] Presigned URL gerada com sucesso para: laudos/lote-1008/laudo-789.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:90:15)

    console.log
      [BACKBLAZE] Fazendo download server-side do PDF...

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:96:15)

    console.log
      [BACKBLAZE] Arquivo remoto encontrado no banco: laudos/lote-1008/laudo-error.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:82:13)

    console.log
      [BACKBLAZE] Provider: b2, endpoint: https://s3.us-east-005.backblazeb2.com, bucket: laudos-qwork, region: us-east-005

      at log (lib/storage/backblaze-client.ts:147:11)

    console.log
      [BACKBLAZE] Key source: BACKBLAZE_KEY_ID=0052a814..., AppKey source: BACKBLAZE_APPLICATION_KEY=K005FuY8...

      at log (lib/storage/backblaze-client.ts:150:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Gerando URL presigned para: laudos/lote-1008/laudo-error.pdf

      at log (lib/storage/backblaze-client.ts:402:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Config: endpoint=https://s3.us-east-005.backblazeb2.com, bucket=laudos-qwork, region=us-east-005

      at log (lib/storage/backblaze-client.ts:403:11)

    console.log
      [BACKBLAZE:getPresignedUrl] URL gerada: https://s3.us-east-005.backblazeb2.com/laudos-qwork/laudos/lote-1008/laudo-error.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-...

      at log (lib/storage/backblaze-client.ts:426:11)

    console.log
      [BACKBLAZE] Presigned URL gerada com sucesso para: laudos/lote-1008/laudo-error.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:90:15)

    console.log
      [BACKBLAZE] Fazendo download server-side do PDF...

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:96:15)

    console.log
      [BACKBLAZE] Arquivo remoto encontrado no banco: laudos/lote-1008/remoto.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:82:13)

    console.log
      [BACKBLAZE] Provider: b2, endpoint: https://s3.us-east-005.backblazeb2.com, bucket: laudos-qwork, region: us-east-005

      at log (lib/storage/backblaze-client.ts:147:11)

    console.log
      [BACKBLAZE] Key source: BACKBLAZE_KEY_ID=0052a814..., AppKey source: BACKBLAZE_APPLICATION_KEY=K005FuY8...

      at log (lib/storage/backblaze-client.ts:150:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Gerando URL presigned para: laudos/lote-1008/remoto.pdf

      at log (lib/storage/backblaze-client.ts:402:11)

    console.log
      [BACKBLAZE:getPresignedUrl] Config: endpoint=https://s3.us-east-005.backblazeb2.com, bucket=laudos-qwork, region=us-east-005

      at log (lib/storage/backblaze-client.ts:403:11)

    console.log
      [BACKBLAZE:getPresignedUrl] URL gerada: https://s3.us-east-005.backblazeb2.com/laudos-qwork/laudos/lote-1008/remoto.pdf?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-C...

      at log (lib/storage/backblaze-client.ts:426:11)

    console.log
      [BACKBLAZE] Presigned URL gerada com sucesso para: laudos/lote-1008/remoto.pdf

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:90:15)

    console.log
      [BACKBLAZE] Fazendo download server-side do PDF...

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:96:15)

    console.log
      [BACKBLAZE] PDF baixado com sucesso (3 bytes)

      at log (app/api/entidade/laudos/[laudoId]/download/route.ts:110:15)

  ÔùÅ GET /api/entidade/laudos/[laudoId]/download - Backblaze Proxy ÔÇ║ Valida├º├úo de Acesso ÔÇ║ deve retornar 403 quando usu├írio n├úo tem sess├úo de entidade

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 500

      40 |       );
      41 |
    > 42 |       expect(response.status).toBe(403);
         |                               ^
      43 |     });
      44 |
      45 |     it('deve retornar 400 quando laudoId ├® inv├ílido', async () => {

      at Object.toBe (__tests__/api/entidade/laudos-download-backblaze-proxy.test.ts:42:31)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 8 passed, 9 total
Snapshots:   0 total
Time:        3.792 s
Ran all test suites matching __tests__/api/entidade/laudos-download-backblaze-proxy.test.ts.
ÔÇëELIFECYCLEÔÇë Test failed. See above for more details.
