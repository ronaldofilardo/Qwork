# RELATÓRIO DE COMPARAÇÃO DE SCHEMAS

**Data:** 02/02/2026 18:07:56  
**Status:** ⚠️ **DIFERENÇAS ENCONTRADAS**

## Resultado

Foram encontradas **1361 linhas diferentes** entre local e produção.

### Estatísticas

| Métrica | Valor |
|---------|-------|
| Apenas no LOCAL | 1252 linhas |
| Apenas no NEON | 109 linhas |
| Total de diferenças | 1361 linhas |

### Detalhes

- **Schema Local:** .\schema-comparison\schema-local-2026-02-02_18-07-49.sql (265.67 KB)
- **Schema Neon:** .\schema-comparison\schema-neon-2026-02-02_18-07-49.sql (236.43 KB)
- **Arquivo de diferenças:** .\schema-comparison\schema-diff-2026-02-02_18-07-49.txt

## Análise

As diferenças podem indicar:

1. **Migrations não aplicadas no Neon** (mais comum)
2. **Migrations não aplicadas localmente**
3. **Alterações manuais no banco**
4. **Diferentes versões do PostgreSQL**

## Primeiras 50 Diferenças

```diff
+ -- Dumped from database version 17.7 (bdd1736)
+ -- Name: public; Type: SCHEMA; Schema: -; Owner: -
+ -- *not* creating schema, since initdb creates it
+ -- Name: nivel_cargo_enum; Type: TYPE; Schema: public; Owner: -
+ CREATE TYPE public.nivel_cargo_enum AS ENUM (
+     'operacional',
+     'gestao'
+     RETURN NULLIF(current_setting('app.current_user_cpf', TRUE), '');
+     WHEN OTHERS THEN RETURN NULL;
+     RETURN NULLIF(current_setting('app.current_user_perfil', TRUE), '');
+     WHEN OTHERS THEN RETURN NULL;
+   -- Só agir quando houve alteração de status
+   -- Calcular estatísticas para o lote afetado
+   -- ✅ Se condição de conclusão for satisfeita, atualizar APENAS o status do lote
+   -- ❌ NÃO EMITIR LAUDO AUTOMATICAMENTE
+     -- Atualizar status do lote para 'concluido' (evitar writes desnecessários)
+     -- ✅ CRIAR NOTIFICAÇÃO para RH/Entidade (ao invés de emitir laudo)
+     -- A notificação será criada pela função recalcularStatusLotePorId() em lib/lotes.ts
+     -- que já tem essa lógica implementada corretamente
+     -- ❌ REMOVIDO: Chamada a upsert_laudo() ou qualquer lógica de emissão
+     -- MOTIVO: Emissão deve ser MANUAL pelo Emissor após solicitação do RH/Entidade
+ COMMENT ON FUNCTION public.fn_recalcular_status_lote_on_avaliacao_update() IS 'Recalcula status do lote quando avaliação muda de status. 
+ APENAS atualiza status para concluido quando todas avaliações finalizadas.
+ NÃO EMITE LAUDO AUTOMATICAMENTE - emissão é manual pelo Emissor.';
+   -- Reservar o mesmo ID para o laudo (em status rascunho) sem atribuir emissor padrão
+ EXCEPTION
+     
+     
+     atualizado_em timestamp without time zone DEFAULT CURRENT_TIMESTAMP
+     clinica_id integer NOT NULL,
+     atualizado_em timestamp without time zone DEFAULT CURRENT_TIMESTAMP
+     nivel_cargo public.nivel_cargo_enum,
+     CONSTRAINT funcionarios_clinica_check CHECK (((clinica_id IS NOT NULL) OR ((perfil)::text = ANY ((ARRAY['emissor'::character varying, 'admin'::character varying])::text[])))),
+     CONSTRAINT funcionarios_perfil_check CHECK (((perfil)::text = ANY (ARRAY[('funcionario'::character varying)::text, ('rh'::character varying)::text, ('admin'::character varying)::text, ('emissor'::character varying)::text])))
+     emissor_cpf character(11) NOT NULL,
+     liberado_por character(11) NOT NULL,
+     laudo_enviado_em timestamp without time zone,
+     finalizado_em timestamp without time zone,
+ -- Name: vw_comparativo_empresas; Type: VIEW; Schema: public; Owner: -
+ CREATE VIEW public.vw_comparativo_empresas AS
+  SELECT ec.clinica_id,
+     ec.id AS empresa_id,
+     ec.nome AS empresa_nome,
+     avg(
+             WHEN (r.grupo = 1) THEN r.valor
+         END) AS demandas_trabalho,
+     avg(
+             WHEN (r.grupo = 2) THEN r.valor
+             ELSE NULL::integer
+         END) AS organizacao_conteudo,
```

## Próximos Passos

1. [ ] Analisar arquivo de diferenças completo: `.\schema-comparison\schema-diff-2026-02-02_18-07-49.txt`
2. [ ] Verificar migrations pendentes:
   ```sql
   SELECT migration_name, applied_at 
   FROM _prisma_migrations 
   ORDER BY migration_name DESC LIMIT 50;
   ```
3. [ ] Aplicar migrations faltantes (se necessário)
4. [ ] Executar novamente este script para validar

## Comandos Úteis

```powershell
# Ver diferenças completas
Get-Content ".\schema-comparison\schema-diff-2026-02-02_18-07-49.txt"

# Aplicar migration específica no Neon
psql $env:DATABASE_URL -f database/migrations/XXX_nome_migration.sql

# Verificar migrations aplicadas
psql $env:DATABASE_URL -c "SELECT * FROM _prisma_migrations ORDER BY migration_name;"
```

