# Deep System Check - Análise Completa

**Data:** 04/02/2026 12:10:48
**Objetivo:** Identificar TODAS as diferenças entre produção e desenvolvimento

---

## 1. TRIGGERS DUPLICADOS/PROBLEMÁTICOS

### Triggers Duplicados em PRODUÇÃO:

````n audit_avaliacoes                                   | avaliacoes          |     3  audit_empresas_clientes                            | empresas_clientes   |     3  audit_funcionarios                                 | funcionarios        |     3  audit_laudos                                       | laudos              |     3  audit_lotes_avaliacao                              | lotes_avaliacao     |     3  trg_protect_senhas                                 | entidades_senhas |     3  trg_recalc_lote_on_avaliacao_change                | avaliacoes          |     3  trigger_resultado_immutability                     | resultados          |     3  enforce_laudo_immutability                         | laudos              |     2  tr_tomadores_sync_status_ativa                  | tomadores        |     2  tr_tomadores_sync_status_ativa_personalizado    | tomadores        |     2  tr_tomadores_sync_status_ativa_robust           | tomadores        |     2  trg_immutable_laudo                                | laudos              |     2  trg_prevent_tomador_emissor                    | entidades_senhas |     2  trg_prevent_gestor_emissor                         | funcionarios        |     2  trg_protect_avaliacao_after_emit                   | avaliacoes          |     2  trg_recibos_criar_pdf_job                          | recibos             |     2  trg_respostas_set_questao                          | respostas           |     2  trg_validar_parcelas                               | contratos_planos    |     2  trigger_garantir_template_padrao_unico             | templates_contrato  |     2  trigger_prevent_avaliacao_mutation_during_emission | avaliacoes          |     2  trigger_resposta_immutability                      | respostas           |     2
```n

## 2. FUNÇÕES EXCLUSIVAS DE PRODUÇÃO

```sql
 fn_limpar_tokens_expirados          | CREATE OR REPLACE FUNCTION public.fn_limpar_tokens_expirados()                                                                                                                                       +                                      |  RETURNS TABLE(tokens_removidos integer)                                                                                                                                                             +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | DECLARE\r                                                                                                                                                                                            +                                      |   total_removidos INTEGER;\r                                                                                                                                                                         +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   DELETE FROM tokens_retomada_pagamento\r                                                                                                                                                            +                                      |   WHERE expiracao < NOW() - INTERVAL '7 days'; -- Mant├®m hist├│rico de 7 dias\r                                                                                                                       +                                      |   \r                                                                                                                                                                                                 +                                      |   GET DIAGNOSTICS total_removidos = ROW_COUNT;\r                                                                                                                                                     +                                      |   \r                                                                                                                                                                                                 +                                      |   RETURN QUERY SELECT total_removidos;\r                                                                                                                                                             +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   fn_marcar_token_usado               | CREATE OR REPLACE FUNCTION public.fn_marcar_token_usado(p_token character varying, p_ip character varying)                                                                                           +                                      |  RETURNS boolean                                                                                                                                                                                     +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   UPDATE tokens_retomada_pagamento\r                                                                                                                                                                 +                                      |   SET usado = true,\r                                                                                                                                                                                +                                      |       usado_em = NOW(),\r                                                                                                                                                                            +                                      |       ip_uso = p_ip\r                                                                                                                                                                                +                                      |   WHERE token = p_token\r                                                                                                                                                                            +                                      |     AND usado = false\r                                                                                                                                                                              +                                      |     AND expiracao > NOW();\r                                                                                                                                                                         +                                      |   \r                                                                                                                                                                                                 +                                      |   RETURN FOUND;\r                                                                                                                                                                                    +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   fn_reconcluir_lote_for_emergencia   | CREATE OR REPLACE FUNCTION public.fn_reconcluir_lote_for_emergencia(p_lote_id integer)                                                                                                               +                                      |  RETURNS boolean                                                                                                                                                                                     +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | DECLARE\r                                                                                                                                                                                            +                                      |   v_liberadas int;\r                                                                                                                                                                                 +                                      |   v_concluidas int;\r                                                                                                                                                                                +                                      |   v_inativadas int;\r                                                                                                                                                                                +                                      |   v_updated int;\r                                                                                                                                                                                   +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   SELECT\r                                                                                                                                                                                           +                                      |     COUNT(*) FILTER (WHERE status != 'rascunho')::int,\r                                                                                                                                             +                                      |     COUNT(*) FILTER (WHERE status = 'concluida')::int,\r                                                                                                                                             +                                      |     COUNT(*) FILTER (WHERE status = 'inativada')::int\r                                                                                                                                              +                                      |   INTO v_liberadas, v_concluidas, v_inativadas\r                                                                                                                                                     +                                      |   FROM avaliacoes\r                                                                                                                                                                                  +                                      |   WHERE lote_id = p_lote_id;\r                                                                                                                                                                       +                                      | \r                                                                                                                                                                                                   +                                      |   IF v_liberadas > 0 AND v_concluidas > 0 AND (v_concluidas + v_inativadas) = v_liberadas THEN\r                                                                                                     +                                      |     UPDATE lotes_avaliacao\r                                                                                                                                                                         +                                      |     SET status = 'concluido', atualizado_em = NOW()\r                                                                                                                                                +                                      |     WHERE id = p_lote_id AND status IS DISTINCT FROM 'concluido'\r                                                                                                                                   +                                      |     RETURNING 1 INTO v_updated;\r                                                                                                                                                                    +                                      | \r                                                                                                                                                                                                   +                                      |     IF FOUND THEN\r                                                                                                                                                                                  +                                      |       INSERT INTO fila_emissao (lote_id, tentativas, max_tentativas, proxima_tentativa)\r                                                                                                            +                                      |       VALUES (p_lote_id, 0, 3, NOW())\r                                                                                                                                                              +                                      |       ON CONFLICT (lote_id) DO NOTHING;\r                                                                                                                                                            +                                      |       RETURN TRUE;\r                                                                                                                                                                                 +                                      |     ELSE\r                                                                                                                                                                                           +                                      |       RETURN FALSE;\r                                                                                                                                                                                +                                      |     END IF;\r                                                                                                                                                                                        +                                      |   END IF;\r                                                                                                                                                                                          +                                      | \r                                                                                                                                                                                                   +                                      |   RETURN FALSE;\r                                                                                                                                                                                    +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   fn_validar_token_pagamento          | CREATE OR REPLACE FUNCTION public.fn_validar_token_pagamento(p_token character varying)                                                                                                              +                                      |  RETURNS TABLE(valido boolean, tomador_id integer, contrato_id integer, plano_id integer, tipo_plano character varying, numero_funcionarios integer, valor_total numeric, erro character varying)+                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   RETURN QUERY\r                                                                                                                                                                                     +                                      |   SELECT \r                                                                                                                                                                                          +                                      |     CASE \r                                                                                                                                                                                          +                                      |       WHEN t.id IS NULL THEN false\r                                                                                                                                                                 +                                      |       WHEN t.usado = true THEN false\r                                                                                                                                                               +                                      |       WHEN t.expiracao < NOW() THEN false\r                                                                                                                                                          +                                      |       ELSE true\r                                                                                                                                                                                    +                                      |     END AS valido,\r                                                                                                                                                                                 +                                      |     t.tomador_id,\r                                                                                                                                                                              +                                      |     t.contrato_id,\r                                                                                                                                                                                 +                                      |     t.plano_id,\r                                                                                                                                                                                    +                                      |     t.tipo_plano,\r                                                                                                                                                                                  +                                      |     t.numero_funcionarios,\r                                                                                                                                                                         +                                      |     t.valor_total,\r                                                                                                                                                                                 +                                      |     CASE \r                                                                                                                                                                                          +                                      |       WHEN t.id IS NULL THEN 'Token n├úo encontrado'\r                                                                                                                                                +                                      |       WHEN t.usado = true THEN 'Token j├í foi utilizado'\r                                                                                                                                            +                                      |       WHEN t.expiracao < NOW() THEN 'Token expirado'\r                                                                                                                                               +                                      |       ELSE NULL\r                                                                                                                                                                                    +                                      |     END AS erro\r                                                                                                                                                                                    +                                      |   FROM tokens_retomada_pagamento t\r                                                                                                                                                                 +                                      |   WHERE t.token = p_token;\r                                                                                                                                                                         +                                      |   \r                                                                                                                                                                                                 +                                      |   IF NOT FOUND THEN\r                                                                                                                                                                                +                                      |     RETURN QUERY SELECT false, NULL::INTEGER, NULL::INTEGER, NULL::INTEGER, \r                                                                                                                       +                                      |                         NULL::VARCHAR, NULL::INTEGER, NULL::DECIMAL, \r                                                                                                                              +                                      |                         'Token n├úo encontrado'::VARCHAR;\r                                                                                                                                           +                                      |   END IF;\r                                                                                                                                                                                          +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   notificar_pre_cadastro_criado       | CREATE OR REPLACE FUNCTION public.notificar_pre_cadastro_criado()                                                                                                                                    +                                      |  RETURNS trigger                                                                                                                                                                                     +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | DECLARE\r                                                                                                                                                                                            +                                      |   v_tomador_nome TEXT;\r                                                                                                                                                                         +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   -- Buscar nome do tomador\r                                                                                                                                                                    +                                      |   SELECT nome INTO v_tomador_nome\r                                                                                                                                                              +                                      |   FROM tomadores\r                                                                                                                                                                                +                                      |   WHERE id = NEW.tomador_id;\r                                                                                                                                                                   +                                      | \r                                                                                                                                                                                                   +                                      |   -- Inserir notifica├º├úo para todos os admins\r                                                                                                                                                      +                                      |   INSERT INTO notificacoes (\r                                                                                                                                                                       +                                      |     tipo,\r                                                                                                                                                                                          +                                      |     prioridade,\r                                                                                                                                                                                    +                                      |     destinatario_id,\r                                                                                                                                                                               +                                      |     destinatario_tipo,\r                                                                                                                                                                             +                                      |     titulo,\r                                                                                                                                                                                        +                                      |     mensagem,\r                                                                                                                                                                                      +                                      |     dados_contexto,\r                                                                                                                                                                                +                                      |     link_acao,\r                                                                                                                                                                                     +                                      |     botao_texto,\r                                                                                                                                                                                   +                                      |     contratacao_personalizada_id\r                                                                                                                                                                   +                                      |   )\r                                                                                                                                                                                                +                                      |   SELECT \r                                                                                                                                                                                          +                                      |     'pre_cadastro_criado',\r                                                                                                                                                                         +                                      |     'alta',\r                                                                                                                                                                                        +                                      |     u.id,\r                                                                                                                                                                                          +                                      |     'admin',\r                                                                                                                                                                                       +                                      |     'Novo Pr├®-Cadastro: ' || v_tomador_nome,\r                                                                                                                                                   +                                      |     'Um novo pr├®-cadastro de plano personalizado foi criado e aguarda defini├º├úo de valor. Funcion├írios estimados: ' || COALESCE(NEW.numero_funcionarios_estimado::TEXT, 'N├úo informado') || '.',\r   +                                      |     jsonb_build_object(\r                                                                                                                                                                            +                                      |       'contratacao_id', NEW.id,\r                                                                                                                                                                    +                                      |       'tomador_nome', v_tomador_nome,\r                                                                                                                                                      +                                      |       'numero_funcionarios', NEW.numero_funcionarios_estimado\r                                                                                                                                      +                                      |     ),\r                                                                                                                                                                                             +                                      |     '/admin/contratacao/pendentes',\r                                                                                                                                                                +                                      |     'Definir Valor',\r                                                                                                                                                                               +                                      |     NEW.id\r                                                                                                                                                                                         +                                      |   FROM usuarios u\r                                                                                                                                                                                  +                                      |   WHERE u.role = 'admin' AND u.ativo = TRUE;\r                                                                                                                                                       +                                      | \r                                                                                                                                                                                                   +                                      |   RETURN NEW;\r                                                                                                                                                                                      +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   notificar_valor_definido            | CREATE OR REPLACE FUNCTION public.notificar_valor_definido()                                                                                                                                         +                                      |  RETURNS trigger                                                                                                                                                                                     +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | DECLARE\r                                                                                                                                                                                            +                                      |   v_tomador_id INT;\r                                                                                                                                                                            +                                      |   v_tomador_nome TEXT;\r                                                                                                                                                                         +                                      |   v_gestor_cpf TEXT;\r                                                                                                                                                                               +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   -- Buscar ID, nome do tomador e CPF do gestor respons├ível\r                                                                                                                                    +                                      |   SELECT c.id, c.nome, c.responsavel_cpf\r                                                                                                                                                           +                                      |   INTO v_tomador_id, v_tomador_nome, v_gestor_cpf\r                                                                                                                                          +                                      |   FROM tomadores c\r                                                                                                                                                                              +                                      |   WHERE c.id = NEW.tomador_id;\r                                                                                                                                                                 +                                      | \r                                                                                                                                                                                                   +                                      |   -- Notificar gestor do tomador (preenchendo tanto id quanto CPF)\r                                                                                                                             +                                      |   INSERT INTO notificacoes (\r                                                                                                                                                                       +                                      |     tipo, prioridade, destinatario_id, destinatario_cpf, destinatario_tipo,\r                                                                                                                        +                                      |     titulo, mensagem, dados_contexto, link_acao, botao_texto,\r                                                                                                                                      +                                      |     contratacao_personalizada_id\r                                                                                                                                                                   +                                      |   )\r                                                                                                                                                                                                +                                      |   VALUES (\r                                                                                                                                                                                         +                                      |     'valor_definido',\r                                                                                                                                                                              +                                      |     'media',\r                                                                                                                                                                                       +                                      |     v_tomador_id,\r                                                                                                                                                                              +                                      |     v_gestor_cpf,\r                                                                                                                                                                                  +                                      |     'gestor',\r                                                                                                                                                                             +                                      |     'Valor Definido para Plano Personalizado',\r                                                                                                                                                     +                                      |     'O valor do seu plano personalizado foi definido. Valor por funcion├írio: R$ ' || \r                                                                                                              +                                      |       TO_CHAR(NEW.valor_por_funcionario, 'FM999G999G990D00') || \r                                                                                                                                   +                                      |       '. Total estimado: R$ ' || TO_CHAR(NEW.valor_total_estimado, 'FM999G999G990D00') || '.',\r                                                                                                     +                                      |     jsonb_build_object(\r                                                                                                                                                                            +                                      |       'contratacao_id', NEW.id,\r                                                                                                                                                                    +                                      |       'valor_por_funcionario', NEW.valor_por_funcionario,\r                                                                                                                                          +                                      |       'valor_total_estimado', NEW.valor_total_estimado,\r                                                                                                                                            +                                      |       'numero_funcionarios', NEW.numero_funcionarios_estimado\r                                                                                                                                      +                                      |     ),\r                                                                                                                                                                                             +                                      |     '/entidade/contratacao/' || NEW.id,\r                                                                                                                                                            +                                      |     'Ver Contrato',\r                                                                                                                                                                                +                                      |     NEW.id\r                                                                                                                                                                                         +                                      |   );\r                                                                                                                                                                                               +                                      | \r                                                                                                                                                                                                   +                                      |   RETURN NEW;\r                                                                                                                                                                                      +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |   trg_recalc_lote_on_avaliacao_change | CREATE OR REPLACE FUNCTION public.trg_recalc_lote_on_avaliacao_change()                                                                                                                              +                                      |  RETURNS trigger                                                                                                                                                                                     +                                      |  LANGUAGE plpgsql                                                                                                                                                                                    +                                      | AS $function$\r                                                                                                                                                                                      +                                      | BEGIN\r                                                                                                                                                                                              +                                      |   -- A fun├º├úo fn_recalcular_status_lote_on_avaliacao_update N├âO aceita par├ómetros\r                                                                                                                  +                                      |   -- Ela ├® um trigger function que usa NEW/OLD automaticamente\r                                                                                                                                     +                                      |   IF TG_OP = 'DELETE' THEN\r                                                                                                                                                                         +                                      |     RETURN fn_recalcular_status_lote_on_avaliacao_update();\r                                                                                                                                        +                                      |   ELSE\r                                                                                                                                                                                             +                                      |     RETURN fn_recalcular_status_lote_on_avaliacao_update();\r                                                                                                                                        +                                      |   END IF;\r                                                                                                                                                                                          +                                      | END;\r                                                                                                                                                                                               +                                      | $function$                                                                                                                                                                                           +                                      |
```n

## 3. VIEWS EXCLUSIVAS DE PRODUÇÃO

```sql
 v_auditoria_emissoes         |  SELECT la.id AS lote_id,                                                                                                                                                                      +                               |     la.empresa_id,                                                                                                                                                                             +                               |     la.numero_ordem,                                                                                                                                                                           +                               |     la.status AS lote_status,                                                                                                                                                                  +                               |     la.emitido_em,                                                                                                                                                                             +                               |     la.enviado_em,                                                                                                                                                                             +                               |     la.processamento_em,                                                                                                                                                                       +                               |     la.criado_em AS lote_criado_em,                                                                                                                                                            +                               |     ec.nome AS empresa_nome,                                                                                                                                                                   +                               |     ec.cnpj AS empresa_cnpj,                                                                                                                                                                   +                               |     c.nome AS clinica_nome,                                                                                                                                                                    +                               |     count(DISTINCT a.id) AS total_avaliacoes,                                                                                                                                                  +                               |     count(DISTINCT                                                                                                                                                                             +                               |         CASE                                                                                                                                                                                   +                               |             WHEN ((a.status)::text = 'concluida'::text) THEN a.id                                                                                                                              +                               |             ELSE NULL::integer                                                                                                                                                                 +                               |         END) AS avaliacoes_concluidas,                                                                                                                                                         +                               |     l.hash_pdf,                                                                                                                                                                                +                               |     l.enviado_em AS laudo_enviado_em,                                                                                                                                                          +                               |     l.emitido_em AS laudo_emitido_em                                                                                                                                                           +                               |    FROM ((((lotes_avaliacao la                                                                                                                                                                 +                               |      JOIN empresas_clientes ec ON ((la.empresa_id = ec.id)))                                                                                                                                   +                               |      JOIN clinicas c ON ((ec.clinica_id = c.id)))                                                                                                                                              +                               |      LEFT JOIN avaliacoes a ON ((la.id = a.lote_id)))                                                                                                                                          +                               |      LEFT JOIN laudos l ON ((la.id = l.lote_id)))                                                                                                                                              +                               |   GROUP BY la.id, la.empresa_id, la.numero_ordem, la.status, la.emitido_em, la.enviado_em, la.processamento_em, la.criado_em, ec.nome, ec.cnpj, c.nome, l.hash_pdf, l.enviado_em, l.emitido_em;  v_relatorio_emissoes_usuario |  SELECT fe.solicitado_por AS cpf,                                                                                                                                                              +                               |     fe.tipo_solicitante AS perfil,                                                                                                                                                             +                               |     count(*) AS total_solicitacoes,                                                                                                                                                            +                               |     count(                                                                                                                                                                                     +                               |         CASE                                                                                                                                                                                   +                               |             WHEN ((l.status)::text = 'emitido'::text) THEN 1                                                                                                                                   +                               |             ELSE NULL::integer                                                                                                                                                                 +                               |         END) AS emissoes_sucesso,                                                                                                                                                              +                               |     count(                                                                                                                                                                                     +                               |         CASE                                                                                                                                                                                   +                               |             WHEN ((l.status)::text = 'enviado'::text) THEN 1                                                                                                                                   +                               |             ELSE NULL::integer                                                                                                                                                                 +                               |         END) AS emissoes_enviadas,                                                                                                                                                             +                               |     count(                                                                                                                                                                                     +                               |         CASE                                                                                                                                                                                   +                               |             WHEN (fe.erro IS NOT NULL) THEN 1                                                                                                                                                  +                               |             ELSE NULL::integer                                                                                                                                                                 +                               |         END) AS emissoes_erro,                                                                                                                                                                 +                               |     count(                                                                                                                                                                                     +                               |         CASE                                                                                                                                                                                   +                               |             WHEN ((l.id IS NULL) AND (fe.tentativas >= fe.max_tentativas)) THEN 1                                                                                                              +                               |             ELSE NULL::integer                                                                                                                                                                 +                               |         END) AS emissoes_falhou,                                                                                                                                                               +                               |     min(fe.solicitado_em) AS primeira_solicitacao,                                                                                                                                             +                               |     max(fe.solicitado_em) AS ultima_solicitacao,                                                                                                                                               +                               |     avg(EXTRACT(epoch FROM (l.emitido_em - fe.solicitado_em))) AS tempo_medio_emissao_segundos                                                                                                 +                               |    FROM (_deprecated_fila_emissao fe                                                                                                                                                           +                               |      LEFT JOIN laudos l ON ((fe.lote_id = l.lote_id)))                                                                                                                                         +                               |   WHERE (fe.solicitado_por IS NOT NULL)                                                                                                                                                        +                               |   GROUP BY fe.solicitado_por, fe.tipo_solicitante                                                                                                                                              +                               |   ORDER BY (count(*)) DESC;
```n

## 4. CONSTRAINTS CRÍTICAS

### Constraints lotes_avaliacao em PRODUÇÃO:
```n fk_lotes_clinica                             | f       | FOREIGN KEY (clinica_id) REFERENCES clinicas(id) ON DELETE RESTRICT  lotes_avaliacao_clinica_id_fkey              | f       | FOREIGN KEY (clinica_id) REFERENCES clinicas(id) ON DELETE CASCADE  lotes_avaliacao_clinica_or_tomador_check | c       | CHECK ((((clinica_id IS NOT NULL) AND (tomador_id IS NULL)) OR ((clinica_id IS NULL) AND (tomador_id IS NOT NULL))))  lotes_avaliacao_tomador_id_fkey          | f       | FOREIGN KEY (tomador_id) REFERENCES tomadores(id) ON DELETE CASCADE  lotes_avaliacao_empresa_id_fkey              | f       | FOREIGN KEY (empresa_id) REFERENCES empresas_clientes(id) ON DELETE CASCADE  lotes_avaliacao_empresa_numero_ordem_unique  | u       | UNIQUE (empresa_id, numero_ordem)  lotes_avaliacao_liberado_por_fkey            | f       | FOREIGN KEY (liberado_por) REFERENCES entidades_senhas(cpf)  lotes_avaliacao_pkey                         | p       | PRIMARY KEY (id)  lotes_avaliacao_status_check                 | c       | CHECK (((status)::text = ANY ((ARRAY['ativo'::character varying, 'cancelado'::character varying, 'finalizado'::character varying, 'concluido'::character varying])::text[])))  lotes_avaliacao_tipo_check                   | c       | CHECK (((tipo)::text = ANY (ARRAY[('completo'::character varying)::text, ('operacional'::character varying)::text, ('gestao'::character varying)::text])))
```n
### Constraints lotes_avaliacao em DESENVOLVIMENTO:
```n fk_lotes_clinica                             | f       | FOREIGN KEY (clinica_id) REFERENCES clinicas(id) ON DELETE RESTRICT  lotes_avaliacao_clinica_id_fkey              | f       | FOREIGN KEY (clinica_id) REFERENCES clinicas(id) ON DELETE CASCADE  lotes_avaliacao_clinica_or_tomador_check | c       | CHECK ((((clinica_id IS NOT NULL) AND (tomador_id IS NULL)) OR ((clinica_id IS NULL) AND (tomador_id IS NOT NULL))))  lotes_avaliacao_tomador_id_fkey          | f       | FOREIGN KEY (tomador_id) REFERENCES tomadores(id) ON DELETE CASCADE  lotes_avaliacao_empresa_id_fkey              | f       | FOREIGN KEY (empresa_id) REFERENCES empresas_clientes(id) ON DELETE CASCADE  lotes_avaliacao_empresa_numero_ordem_unique  | u       | UNIQUE (empresa_id, numero_ordem)  lotes_avaliacao_liberado_por_fkey            | f       | FOREIGN KEY (liberado_por) REFERENCES entidades_senhas(cpf)  lotes_avaliacao_pkey                         | p       | PRIMARY KEY (id)  lotes_avaliacao_status_check                 | c       | CHECK (((status)::text = ANY ((ARRAY['rascunho'::character varying, 'ativo'::character varying, 'concluido'::character varying, 'emissao_solicitada'::character varying, 'emissao_em_andamento'::character varying, 'laudo_emitido'::character varying, 'cancelado'::character varying, 'finalizado'::character varying])::text[])))  lotes_avaliacao_tipo_check                   | c       | CHECK (((tipo)::text = ANY (ARRAY[('completo'::character varying)::text, ('operacional'::character varying)::text, ('gestao'::character varying)::text])))
```n
### Constraints avaliacoes em PRODUÇÃO:
```n avaliacoes_funcionario_cpf_fkey | f       | FOREIGN KEY (funcionario_cpf) REFERENCES funcionarios(cpf) ON DELETE CASCADE  avaliacoes_lote_id_fkey         | f       | FOREIGN KEY (lote_id) REFERENCES lotes_avaliacao(id) ON DELETE SET NULL  avaliacoes_pkey                 | p       | PRIMARY KEY (id)  avaliacoes_status_check         | c       | CHECK (((status)::text = ANY (ARRAY[('iniciada'::character varying)::text, ('em_andamento'::character varying)::text, ('concluida'::character varying)::text, ('inativada'::character varying)::text])))  fk_avaliacoes_funcionario       | f       | FOREIGN KEY (funcionario_cpf) REFERENCES funcionarios(cpf) ON DELETE RESTRICT
```n
### Constraints avaliacoes em DESENVOLVIMENTO:
```n avaliacoes_funcionario_cpf_fkey | f       | FOREIGN KEY (funcionario_cpf) REFERENCES funcionarios(cpf) ON DELETE CASCADE  avaliacoes_lote_id_fkey         | f       | FOREIGN KEY (lote_id) REFERENCES lotes_avaliacao(id) ON DELETE SET NULL  avaliacoes_pkey                 | p       | PRIMARY KEY (id)  avaliacoes_status_check         | c       | CHECK (((status)::text = ANY (ARRAY[('iniciada'::character varying)::text, ('em_andamento'::character varying)::text, ('concluida'::character varying)::text, ('inativada'::character varying)::text])))  fk_avaliacoes_funcionario       | f       | FOREIGN KEY (funcionario_cpf) REFERENCES funcionarios(cpf) ON DELETE RESTRICT
```n

## 5. COLUNAS DAS TABELAS PRINCIPAIS

### Tabela: lotes_avaliacao
**PRODUÇÃO:**
```n id               | integer                     | NO          | nextval('lotes_avaliacao_id_seq'::regclass)  clinica_id       | integer                     | YES         |   empresa_id       | integer                     | YES         |   descricao        | text                        | YES         |   tipo             | character varying           | YES         | 'completo'::character varying  status           | character varying           | YES         | 'ativo'::status_lote_enum  liberado_por     | character                   | YES         |   liberado_em      | timestamp without time zone | YES         | CURRENT_TIMESTAMP  criado_em        | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em    | timestamp without time zone | YES         | CURRENT_TIMESTAMP  laudo_enviado_em | timestamp without time zone | YES         |   finalizado_em    | timestamp without time zone | YES         |   numero_ordem     | integer                     | NO          | 1  tomador_id   | integer                     | YES         |   emitido_em       | timestamp with time zone    | YES         |   enviado_em       | timestamp with time zone    | YES         |   hash_pdf         | character varying           | YES         |   setor_id         | integer                     | YES         |   processamento_em | timestamp without time zone | YES         |
```n
**DESENVOLVIMENTO:**
```n id                | integer                     | NO          | fn_next_lote_id()  clinica_id        | integer                     | YES         |   empresa_id        | integer                     | YES         |   descricao         | text                        | YES         |   tipo              | character varying           | YES         | 'completo'::character varying  status            | character varying           | YES         | 'ativo'::status_lote_enum  liberado_por      | character                   | YES         |   liberado_em       | timestamp without time zone | YES         | CURRENT_TIMESTAMP  criado_em         | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em     | timestamp without time zone | YES         | CURRENT_TIMESTAMP  tomador_id    | integer                     | YES         |   hash_pdf          | character varying           | YES         |   numero_ordem      | integer                     | NO          | 1  emitido_em        | timestamp with time zone    | YES         |   enviado_em        | timestamp with time zone    | YES         |   setor_id          | integer                     | YES         |   laudo_enviado_em  | timestamp without time zone | YES         |   finalizado_em     | timestamp without time zone | YES         |   modo_emergencia   | boolean                     | YES         | false  motivo_emergencia | text                        | YES         |
```n
### Tabela: avaliacoes
**PRODUÇÃO:**
```n id                | integer                     | NO          | nextval('avaliacoes_id_seq'::regclass)  funcionario_cpf   | character                   | NO          |   inicio            | timestamp without time zone | YES         | CURRENT_TIMESTAMP  envio             | timestamp without time zone | YES         |   status            | character varying           | YES         | 'iniciada'::character varying  grupo_atual       | integer                     | YES         | 1  criado_em         | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em     | timestamp without time zone | YES         | CURRENT_TIMESTAMP  lote_id           | integer                     | YES         |   inativada_em      | timestamp with time zone    | YES         |   motivo_inativacao | text                        | YES         |   concluida_em      | timestamp without time zone | YES         |
```n
**DESENVOLVIMENTO:**
```n id                | integer                     | NO          | nextval('avaliacoes_id_seq'::regclass)  funcionario_cpf   | character                   | NO          |   inicio            | timestamp without time zone | YES         | CURRENT_TIMESTAMP  envio             | timestamp without time zone | YES         |   status            | character varying           | YES         | 'iniciada'::character varying  grupo_atual       | integer                     | YES         | 1  criado_em         | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em     | timestamp without time zone | YES         | CURRENT_TIMESTAMP  lote_id           | integer                     | YES         |   inativada_em      | timestamp with time zone    | YES         |   motivo_inativacao | text                        | YES         |   concluida_em      | timestamp without time zone | YES         |
```n
### Tabela: laudos
**PRODUÇÃO:**
```n id                        | integer                     | NO          | nextval('laudos_id_seq'::regclass)  lote_id                   | integer                     | NO          |   emissor_cpf               | character                   | YES         |   observacoes               | text                        | YES         |   status                    | character varying           | YES         | 'emitido'::status_laudo_enum  criado_em                 | timestamp without time zone | YES         | CURRENT_TIMESTAMP  emitido_em                | timestamp without time zone | YES         |   enviado_em                | timestamp without time zone | YES         |   atualizado_em             | timestamp without time zone | YES         | CURRENT_TIMESTAMP  relatorio_individual      | bytea                       | YES         |   relatorio_lote            | bytea                       | YES         |   relatorio_setor           | bytea                       | YES         |   hash_relatorio_individual | character varying           | YES         |   hash_relatorio_lote       | character varying           | YES         |   hash_relatorio_setor      | character varying           | YES         |   hash_pdf                  | character varying           | YES         |
```n
**DESENVOLVIMENTO:**
```n id                        | integer                     | NO          | nextval('laudos_id_seq'::regclass)  lote_id                   | integer                     | NO          |   emissor_cpf               | character                   | YES         |   observacoes               | text                        | YES         |   status                    | character varying           | YES         | 'emitido'::status_laudo_enum  criado_em                 | timestamp without time zone | YES         | CURRENT_TIMESTAMP  emitido_em                | timestamp without time zone | YES         |   enviado_em                | timestamp without time zone | YES         |   atualizado_em             | timestamp without time zone | YES         | CURRENT_TIMESTAMP  hash_pdf                  | character varying           | YES         |   job_id                    | bigint                      | YES         |   arquivo_remoto_provider   | character varying           | YES         |   arquivo_remoto_bucket     | character varying           | YES         |   arquivo_remoto_key        | character varying           | YES         |   arquivo_remoto_url        | text                        | YES         |   relatorio_individual      | bytea                       | YES         |   relatorio_lote            | bytea                       | YES         |   relatorio_setor           | bytea                       | YES         |   hash_relatorio_individual | character varying           | YES         |   hash_relatorio_lote       | character varying           | YES         |   hash_relatorio_setor      | character varying           | YES         |
```n
### Tabela: funcionarios
**PRODUÇÃO:**
```n id                              | integer                     | NO          | nextval('funcionarios_id_seq'::regclass)  cpf                             | character                   | NO          |   nome                            | character varying           | NO          |   setor                           | character varying           | YES         |   funcao                          | character varying           | YES         |   email                           | character varying           | YES         |   senha_hash                      | text                        | NO          |   perfil                          | character varying           | YES         | 'funcionario'::character varying  ativo                           | boolean                     | YES         | true  criado_em                       | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em                   | timestamp without time zone | YES         | CURRENT_TIMESTAMP  clinica_id                      | integer                     | YES         |   empresa_id                      | integer                     | YES         |   matricula                       | character varying           | YES         |   turno                           | character varying           | YES         |   escala                          | character varying           | YES         |   nivel_cargo                     | USER-DEFINED                | YES         |   data_nascimento                 | date                        | YES         |   incluido_em                     | timestamp without time zone | YES         | CURRENT_TIMESTAMP  inativado_em                    | timestamp without time zone | YES         |   inativado_por                   | character varying           | YES         |   data_admissao                   | date                        | YES         |   ultima_avaliacao_id             | integer                     | YES         |   ultima_avaliacao_data_conclusao | timestamp without time zone | YES         |   ultima_avaliacao_status         | character varying           | YES         |   ultimo_motivo_inativacao        | text                        | YES         |   indice_avaliacao                | integer                     | NO          | 0  data_ultimo_lote                | timestamp without time zone | YES         |   tomador_id                  | integer                     | YES         |   usuario_tipo                    | USER-DEFINED                | NO          |
```n
**DESENVOLVIMENTO:**
```n id                              | integer                     | NO          | nextval('funcionarios_id_seq'::regclass)  cpf                             | character                   | NO          |   nome                            | character varying           | NO          |   setor                           | character varying           | YES         |   funcao                          | character varying           | YES         |   email                           | character varying           | YES         |   senha_hash                      | text                        | NO          |   perfil                          | character varying           | YES         | 'funcionario'::character varying  ativo                           | boolean                     | YES         | true  criado_em                       | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em                   | timestamp without time zone | YES         | CURRENT_TIMESTAMP  clinica_id                      | integer                     | YES         |   empresa_id                      | integer                     | YES         |   matricula                       | character varying           | YES         |   turno                           | character varying           | YES         |   escala                          | character varying           | YES         |   nivel_cargo                     | character varying           | YES         |   ultima_avaliacao_id             | integer                     | YES         |   ultima_avaliacao_data_conclusao | timestamp without time zone | YES         |   ultima_avaliacao_status         | character varying           | YES         |   ultimo_motivo_inativacao        | text                        | YES         |   data_ultimo_lote                | timestamp without time zone | YES         |   data_nascimento                 | date                        | YES         |   tomador_id                  | integer                     | YES         |   indice_avaliacao                | integer                     | NO          | 0  usuario_tipo                    | USER-DEFINED                | NO          |   incluido_em                     | timestamp without time zone | YES         | CURRENT_TIMESTAMP  inativado_em                    | timestamp without time zone | YES         |   inativado_por                   | character varying           | YES         |   ultimo_lote_codigo              | character varying           | YES         |
```n
### Tabela: empresas_clientes
**PRODUÇÃO:**
```n id                  | integer                     | NO          | nextval('empresas_clientes_id_seq'::regclass)  nome                | character varying           | NO          |   cnpj                | character varying           | NO          |   email               | character varying           | YES         |   telefone            | character varying           | YES         |   endereco            | text                        | YES         |   cidade              | character varying           | YES         |   estado              | character varying           | YES         |   cep                 | character varying           | YES         |   ativa               | boolean                     | YES         | true  clinica_id          | integer                     | NO          |   criado_em           | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em       | timestamp without time zone | YES         | CURRENT_TIMESTAMP  representante_nome  | text                        | YES         |   representante_fone  | text                        | YES         |   representante_email | text                        | YES         |   responsavel_email   | text                        | YES         |
```n
**DESENVOLVIMENTO:**
```n id                  | integer                     | NO          | nextval('empresas_clientes_id_seq'::regclass)  nome                | character varying           | NO          |   cnpj                | character varying           | NO          |   email               | character varying           | YES         |   telefone            | character varying           | YES         |   endereco            | text                        | YES         |   cidade              | character varying           | YES         |   estado              | character varying           | YES         |   cep                 | character varying           | YES         |   ativa               | boolean                     | YES         | true  clinica_id          | integer                     | YES         |   criado_em           | timestamp without time zone | YES         | CURRENT_TIMESTAMP  atualizado_em       | timestamp without time zone | YES         | CURRENT_TIMESTAMP  tomador_id      | integer                     | YES         |   representante_nome  | text                        | YES         |   representante_fone  | character varying           | YES         |   representante_email | character varying           | YES         |   responsavel_email   | text                        | YES         |
```n
### Tabela: audit_logs
**PRODUÇÃO:**
```n id             | bigint                      | NO          | nextval('audit_logs_id_seq'::regclass)  user_cpf       | character                   | YES         |   user_perfil    | character varying           | YES         |   action         | character varying           | NO          |   resource       | character varying           | NO          |   resource_id    | text                        | YES         |   old_data       | jsonb                       | YES         |   new_data       | jsonb                       | YES         |   ip_address     | inet                        | YES         |   user_agent     | text                        | YES         |   details        | text                        | YES         |   created_at     | timestamp without time zone | NO          | CURRENT_TIMESTAMP  tomador_id | integer                     | YES         |   clinica_id     | integer                     | YES         |
```n
**DESENVOLVIMENTO:**
```n id             | bigint                      | NO          | nextval('audit_logs_id_seq'::regclass)  user_cpf       | character                   | YES         |   user_perfil    | character varying           | YES         |   action         | character varying           | NO          |   resource       | character varying           | NO          |   resource_id    | text                        | YES         |   old_data       | jsonb                       | YES         |   new_data       | jsonb                       | YES         |   ip_address     | inet                        | YES         |   user_agent     | text                        | YES         |   details        | text                        | YES         |   created_at     | timestamp without time zone | NO          | CURRENT_TIMESTAMP  tomador_id | integer                     | YES         |   clinica_id     | integer                     | YES         |
```n
### Tabela: auditoria_laudos
**PRODUÇÃO:**
```n id               | bigint                      | NO          | nextval('auditoria_laudos_id_seq'::regclass)  lote_id          | integer                     | NO          |   laudo_id         | integer                     | YES         |   emissor_cpf      | character varying           | YES         |   emissor_nome     | character varying           | YES         |   acao             | character varying           | NO          |   status           | character varying           | NO          |   ip_address       | inet                        | YES         |   observacoes      | text                        | YES         |   criado_em        | timestamp without time zone | NO          | now()  solicitado_por   | character varying           | YES         |   tipo_solicitante | character varying           | YES         |   tentativas       | integer                     | YES         | 0  erro             | text                        | YES         |
```n
**DESENVOLVIMENTO:**
```n id               | bigint                      | NO          | nextval('auditoria_laudos_id_seq'::regclass)  lote_id          | integer                     | NO          |   laudo_id         | integer                     | YES         |   emissor_cpf      | character varying           | YES         |   emissor_nome     | character varying           | YES         |   acao             | character varying           | NO          |   status           | character varying           | NO          |   ip_address       | inet                        | YES         |   observacoes      | text                        | YES         |   criado_em        | timestamp without time zone | NO          | now()  solicitado_por   | character varying           | YES         |   tipo_solicitante | character varying           | YES         |   tentativas       | integer                     | YES         | 0  erro             | text                        | YES         |
```n

## 6. ENDPOINTS API

### Endpoints RH (31):
```n/api/C:/apps/QWork/app/api/rh/account-info
/api/C:/apps/QWork/app/api/rh/dashboard
/api/C:/apps/QWork/app/api/rh/empresas
/api/C:/apps/QWork/app/api/rh/empresas/[id]
/api/C:/apps/QWork/app/api/rh/funcionarios
/api/C:/apps/QWork/app/api/rh/funcionarios/import
/api/C:/apps/QWork/app/api/rh/funcionarios/status
/api/C:/apps/QWork/app/api/rh/funcionarios/status/batch
/api/C:/apps/QWork/app/api/rh/funcionarios/[cpf]
/api/C:/apps/QWork/app/api/rh/laudos
/api/C:/apps/QWork/app/api/rh/laudos/[laudoId]/download
/api/C:/apps/QWork/app/api/rh/liberar-lote
/api/C:/apps/QWork/app/api/rh/liberar-por-nivel
/api/C:/apps/QWork/app/api/rh/lotes
/api/C:/apps/QWork/app/api/rh/lotes/aguardando-envio
/api/C:/apps/QWork/app/api/rh/lotes/laudo-emitido
/api/C:/apps/QWork/app/api/rh/lotes/laudo-para-emitir
/api/C:/apps/QWork/app/api/rh/lotes/[id]
/api/C:/apps/QWork/app/api/rh/lotes/[id]/avaliacoes/[avaliacaoId]/inativar
/api/C:/apps/QWork/app/api/rh/lotes/[id]/avaliacoes/[avaliacaoId]/reset
/api/C:/apps/QWork/app/api/rh/lotes/[id]/funcionarios
/api/C:/apps/QWork/app/api/rh/notificacoes
/api/C:/apps/QWork/app/api/rh/notificacoes/stream
/api/C:/apps/QWork/app/api/rh/parcelas
/api/C:/apps/QWork/app/api/rh/parcelas/download-recibo
/api/C:/apps/QWork/app/api/rh/parcelas/gerar-recibo
/api/C:/apps/QWork/app/api/rh/pendencias
/api/C:/apps/QWork/app/api/rh/relatorio-individual-pdf
/api/C:/apps/QWork/app/api/rh/relatorio-lote-pdf
/api/C:/apps/QWork/app/api/rh/relatorio-setor
/api/C:/apps/QWork/app/api/rh/relatorio-setor-pdf
```n
### Endpoints Entidade (24):
```n/api/C:/apps/QWork/app/api/entidade/account-info
/api/C:/apps/QWork/app/api/entidade/contrato-fallback
/api/C:/apps/QWork/app/api/entidade/dashboard
/api/C:/apps/QWork/app/api/entidade/empresas
/api/C:/apps/QWork/app/api/entidade/funcionarios
/api/C:/apps/QWork/app/api/entidade/funcionarios/import
/api/C:/apps/QWork/app/api/entidade/funcionarios/status
/api/C:/apps/QWork/app/api/entidade/laudos
/api/C:/apps/QWork/app/api/entidade/laudos/[laudoId]/download
/api/C:/apps/QWork/app/api/entidade/liberar-lote
/api/C:/apps/QWork/app/api/entidade/lote/[id]
/api/C:/apps/QWork/app/api/entidade/lote/[id]/avaliacoes/[avaliacaoId]/inativar
/api/C:/apps/QWork/app/api/entidade/lote/[id]/avaliacoes/[avaliacaoId]/reset
/api/C:/apps/QWork/app/api/entidade/lote/[id]/download
/api/C:/apps/QWork/app/api/entidade/lote/[id]/funcionarios/export
/api/C:/apps/QWork/app/api/entidade/lote/[id]/relatorio
/api/C:/apps/QWork/app/api/entidade/lote/[id]/relatorio-individual
/api/C:/apps/QWork/app/api/entidade/lote/[id]/relatorio-individual/[avaliacaoId]/html
/api/C:/apps/QWork/app/api/entidade/lotes
/api/C:/apps/QWork/app/api/entidade/lotes/[id]/avaliacoes/[avaliacaoId]/reset
/api/C:/apps/QWork/app/api/entidade/notificacoes
/api/C:/apps/QWork/app/api/entidade/parcelas
/api/C:/apps/QWork/app/api/entidade/parcelas/download-recibo
/api/C:/apps/QWork/app/api/entidade/parcelas/gerar-recibo
```n

## 7. CONFIGURAÇÕES E VARIÁVEIS

### Variáveis de ambiente (.env.local):
```bash
LOCAL_DATABASE_URL=postgresql://postgres:123456@localhost:5432/nr-bps_db
DATABASE_URL=postgresql://neondb_owner:npg_J2QYqn5oxCzp@ep-divine-sky-acuderi7-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
NEXT_PUBLIC_API_URL=http://localhost:3000
NEXT_PUBLIC_BASE_URL=http://localhost:3000
NEXT_PUBLIC_DISABLE_ANEXOS=true
AUTO_LAUDO_LOCAL_ONLY=true
LAUDOS_STORAGE=s3
BACKBLAZE_ENDPOINT=https://s3.us-east-005.backblazeb2.com
BACKBLAZE_REGION=us-east-005
BACKBLAZE_BUCKET=laudos-qwork
BACKBLAZE_KEY_ID=***REDACTED***
BACKBLAZE_SECRET_ACCESS_KEY=***REDACTED***
BACKBLAZE_APPLICATION_KEY=***REDACTED***
PDF_GENERATION_MODE=client
```n

## 8. MIGRATIONS APLICADAS MANUALMENTE

### Arquivos de migration no repositório:
```n000_create_status_lote_tmp.sql
001_security_rls_rbac.sql
002_add_aguardando_pagamento_to_status_enum.sql
002_enable_rls.sql
003_add_numero_funcionarios_estimado_to_tomadores.sql
003_auditoria_completa.sql
004_add_laudo_enviado_em.sql
004_create_contratos_table.sql
004_rls_rbac_fixes.sql
005_add_acceptance_fields_to_contratos.sql
005_fix_duplicated_fk_and_constraints.sql
006_add_helpers_and_contrato_columns.sql
006_add_representante_cnpj_global.sql
006_centralize_enums.sql
007_add_inativacao_fields.sql
007_add_recibo_fields_to_pagamentos.sql
007_refactor_status_fila_emissao.sql
007a_enum_changes.sql
007b_fila_emissao.sql
007c_triggers_audit.sql
007d_rls.sql
007e_views.sql
008_criar_funcao_criar_notificacao_recibo.sql
008_update_vw_funcionarios_por_lote.sql
009_add_data_admissao_funcionarios.sql
009_fix_gerar_hash_auditoria_timestamptz.sql
009_remove_contrato_columns.sql
010_fix_notificacoes_destinatario_cpf.sql
010_update_vw_funcionarios_por_lote_data_admissao.sql
011_enable_pgcrypto_extension.sql
011_fix_clinicas_empresas_fk.sql
011_fix_vw_funcionarios_por_lote.sql
012_exclude_rh_gestores_from_eligibility.sql
012_remove_redundant_table.sql
012_simplify_laudo_status.sql
013_create_auditoria_laudos.sql
013_fix_avaliacao_lote_status_logic.sql
013_nivel_cargo_not_null.sql
013_remove_rascunho_status.sql
013b_create_nivel_cargo_enum_column.sql
013c_modify_nivel_cargo_constraint_remove_rh.sql
014_add_finalizado_em.sql
014_add_fk_analise_estatistica.sql
014_fix_calcular_elegibilidade_text_cast.sql
015_extend_notificacoes.sql
015_include_boundary_in_calcular_elegibilidade.sql
016_add_ultima_avaliacao_denormalized.sql
016_add_ultima_avaliacao_simple.sql
017_add_laudo_files_columns.sql
017_fix_indice_orfao.sql
019_admin_restrict_to_cadastros.sql
021_add_contratos_payment_fields.sql
023_sistema_notificacoes_fix.sql
023_sistema_notificacoes.sql
024_add_tipo_notificacao_laudo_emitido_automaticamente.sql
024_centro_operacoes_notificacoes.sql
024_prioridade_baixa_features.sql
025_substituir_laudo_emitido_por_enviado.sql
026_allow_laudo_enviado_update_trigger_fix.sql
026_campos_pagamento_completo.sql
027_plano_intermediario.sql
028_adicionar_parcelas_pagamentos.sql
028_correcoes_banco_alto.sql
029_correcoes_rbac_rls.sql
030_add_valor_personalizado_contratos.sql
030_adicionar_detalhes_parcelas_pagamentos.sql
030_immutability_triggers_constraints.sql
030_protecao_senhas_critica.sql
031_sync_tomadores_ativa_status.sql
032_add_inativa_status.sql
033_sync_status_ativa_robust.sql
034_sistema_notificacoes_admin.sql
035_create_pdf_jobs_table.sql
040_cleanup_contratacao_personalizada.sql
041_criar_tabela_recibos.sql
042_add_tomador_id_to_clinicas.sql
042_add_pdf_bytea_to_recibos.sql
042_add_valor_parcela_to_vw_recibos.sql
043_add_payment_fields_contratacao_personalizada.sql
043_create_auditoria_recibos.sql
043_recibos_unique_pagamento_enum_notificacoes.sql
044_add_portuguese_timestamps_contratacao_personalizada.sql
044_create_mat_vw_recibos.sql
044_fix_payment_link_token_unique.sql
045_sync_numero_funcionarios.sql
046_auditoria_campos_criticos.sql
047_fix_payment_first_trigger.sql
048_fix_trigger_rejeitado.sql
050_create_contratos_table.sql
051_create_contratacao_personalizada.sql
052_add_pagamentos_contrato_id.sql
052_cleanup_personalizado_fluxo.sql
052_remove_payment_link_tokens.sql
053_add_contrato_aceito_tomadores.sql
053_add_status_analise.sql
053_restore_payment_columns_contratacao_personalizada.sql
053_trigger_sync_personalizado.sql
054_add_pagamentos_detalhes_parcelas.sql
054_function_criar_conta_responsavel.sql
054_replace_ativo_in_contratos.sql
055_add_nome_fantasia_clinicas.sql
055_admin_empresas_fix.sql
056_create_usuarios_minimal.sql
057_fix_trigger_notificacao_sem_justificativa.sql
058_fix_trigger_colunas_corretas.sql
059_add_status_fluxo_personalizado.sql
059_fix_trigger_valor_definido.sql
060_performance_indexes.sql
061_add_tomador_id_to_lotes_avaliacao.sql
062_add_calcular_elegibilidade_lote_tomador.sql
063_update_rls_policies_for_entity_lotes.sql
064_fix_entidade_perfil_rls.sql
065_laudo_idempotency.sql
066_observability_views.sql
067_audit_tomador_id.sql
068_relax_funcionarios_clinica_check.sql
069_relax_funcionarios_clinica_check_not_valid.sql
070_add_emissao_queue.sql
070_emissor_independente.sql
070_relax_funcionarios_nivel_cargo_check_not_valid.sql
070_relax_funcionarios_owner_check.sql
070_remove_laudo_binary_columns.sql
071_add_data_nascimento_funcionarios.sql
071_fix_funcionarios_clinica_id_check.sql
071_protect_after_emissao.sql
072_fix_funcionarios_clinica_check_include_tomador.sql
072_fix_lote_trigger_allow_date_updates.sql
073_fix_elegibilidade_considera_apenas_concluidas.sql
073_fix_funcionarios_clinica_check_tomador.sql
074_defensive_audit_lote_status_change.sql
074_fix_audit_trigger_allow_null_perfil.sql
074_fix_elegibilidade_indice_atrasado_vs_conclusao_recente.sql
075_add_emissao_automatica_fix_flow.sql
075_apply_indice_avaliacao.sql
076_add_questao_to_respostas.sql
076_create_auditoria_notificacoes.sql
076_defensive_audit_log_function.sql
076_populate_questao_non_concluded_respostas.sql
076_safe_recreate_views.sql
077_add_clinica_id_to_audit_logs.sql
078_fix_audit_log_with_context_ip_cast.sql
078_unify_lote_laudo_ids.sql
079_fix_audit_laudo_creation_column.sql
079_trigger_recalc_lote_on_avaliacao_update.sql
080_readd_hash_pdf_to_laudos.sql
080_update_verificar_inativacao_consecutiva_fixed.sql
080_update_verificar_inativacao_consecutiva.sql
081_enforce_laudo_id_equals_lote.sql
081_remove_liberada_status.sql
082_fix_funcionarios_owner_check_include_admin.sql
082_generate_laudo_immediately_on_concluido.sql
083_sync_lote_laudo_sequences.sql
084_fix_contracts_and_tomadores_columns.sql
084_update_upsert_laudo_for_reserved_ids.sql
085_convert_status_columns_to_enum_fix_defaults.sql
085_lote_id_allocator.sql
085_remove_codigo_titulo_lote.sql
086_convert_tomadores_status_with_trigger_handling.sql
086_fn_reservar_laudo_compat_status.sql
087_convert_tomadores_status_with_policy_fix.sql
089_recreate_pagamentos_responsavel_select_with_enum.sql
091_add_aprovacao_fields_to_tomadores.sql
091_remove_legacy_emissor_default.sql
092_create_fn_create_funcionario_autorizado.sql
092_fix_legacy_emissor_update.sql
093_allow_gestor_with_tomador.sql
093_allow_null_emissor_on_laudos.sql
094_debug_fn_create_funcionario_add_notices.sql
098_add_status_values.sql
098_corrigir_funcao_prevent_lote_mutation.sql
099_allow_null_user_cpf_audit.sql
099_corrigir_funcao_prevent_mutation_during_emission.sql
099_emissor_global_rls.sql
099_fix_validar_transicao_status_enum_comparison.sql
099_remove_legacy_profile.sql
100_add_data_liberacao_login.sql
100_add_trigger_block_mutations_during_emission.sql
100_fix_funcionarios_constraints.sql
100_fix_sync_contratacao_status_enum.sql
1000_adicionar_constraints_tipo.sql
1000_religar_gestores_desconectados.sql
1000_sync_prod_from_dev.sql
1001_estrutura_roles_e_imutabilidade.sql
1001_fix_audit_lote_user_cpf.sql
1002_adicionar_hashes_laudos.sql
1002_rastreabilidade_emissao_manual.sql
1003_fix_tomador_id_funcionarios.sql
1003_fix_fn_reservar_id_laudo.sql
1004_add_usuario_tipo_to_funcionarios.sql
1004_auto_recalc_lote_status.sql
1005_create_missing_recalc_function.sql
1005_fix_enum_rascunho_values.sql
1006_fix_laudos_status_check.sql
1007_fix_validar_sessao_rls_variable.sql
101_add_fila_emissao_unique_constraint.sql
101_drop_constraints_then_fix.sql
101_fix_sync_personalizado_status_enum.sql
101_update_audit_trigger_system_user.sql
102_populate_data_liberacao_login.sql
102_update_rls_processamento_em_policies.sql
103_add_missing_ultima_avaliacao_columns.sql
104_fix_audit_trigger_function.sql
104_remove_super_role.sql
105_fix_audit_trigger_columns.sql
106_add_idempotency_columns_pagamentos.sql
107_add_parcela_numero_recibos.sql
107_add_payment_links.sql
108_add_clinica_id_recibos.sql
108_add_tomador_id_to_funcionarios.sql
109_fix_funcionarios_owner_check_use_tomador_id.sql
110_add_processamento_em.sql
110_include_rh_in_owner_check.sql
112_canonizar_status_laudo_enviado.sql
113_create_avaliacao_resets.sql
114_consolidate_rls_funcionarios.sql
115_add_representante_columns_if_missing.sql
117_add_missing_relatorio_columns.sql
130_remove_auto_emission_columns.sql
131_add_emitido_enviado_columns_node.sql
131_add_emitido_enviado_columns.sql
131_replace_recalcular_status_lote_manual.sql
132_create_semantic_views.sql
150_remove_auto_emission_trigger.sql
151_remove_auto_laudo_creation_trigger.sql
152_add_tipo_notificacao_emissao_solicitada.sql
153_restore_manual_emission_requests.sql
160_remove_codigo_padronizar_id.sql
161_recreate_v_auditoria_emissoes.sql
162_fix_validar_lote_pre_laudo_concluido.sql
163_remove_modo_emergencia_fields.sql
164_remove_codigo_titulo_emergencia_definitivo_TEST.sql
164_remove_codigo_titulo_emergencia_definitivo.sql
200_add_emissao_status_states.sql
200_fase1_normalizacao_usuario_tipo.sql
200_prevent_gestor_emissor.sql
201_fase2_refatorar_rls.sql
201_fix_gestor_as_funcionario.sql
201_insert_missing_clinicas_from_tomadores.sql
201_normalize_remove_fila_emissao_redundancy.sql
202_add_constraints_and_indexes.sql
202_otimizar_auditoria_laudos.sql
202_remove_lote_and_emissor.sql
202_restrict_admin_funcionarios_to_platform.sql
20260126_add_entidades_senhas_columns.sql
203_disallow_gestor_in_funcionarios.sql
204_allow_liberado_por_nullable.sql
205_add_concluida_em_to_avaliacoes.sql
206_add_gestor_role.sql
207_add_current_user_tomador_id_helper.sql
208_sync_with_neon.sql
209_fix_admin_rls_critical.sql
210_validate_rls_helpers.sql
211_create_dba_maintenance_role.sql
212_consolidate_tomador_relationship.sql
213_cleanup_policy_drops.sql
220_fix_lotes_avaliacao_schema_entity_support.sql
222_add_unique_empresa_numero_ordem.sql
300_update_rls_exclude_gestores.sql
301_cleanup_gestores_funcionarios.sql
302_fix_lote_id_allocator.sql
303_fix_lotes_avaliacao_liberado_por_fk.sql
304_validate_gestores_post_refactor.sql
996_prevent_modification_after_emission.sql
997_fila_emissao_rls_policies.sql
997_fix_prevent_modification_trigger.sql
998_allow_reset_concluded_evaluations.sql
998_fila_emissao_unique_constraint.sql
999_consolidacao_tipo_plano.sql
999_correcoes_criticas_seguranca.sql
999_fix_audit_laudo_trigger.sql
999_fix_audit_lote_and_status_security.sql
999_fix_contratos_numero_contrato.sql
999_fix_missing_audit_and_validator.sql
999_reserva_id_laudo_on_lote_insert.sql
migration-005-tokens-retomada.sql
migration-006-fix-ativa-default.sql
migration-007-fix-sync-trigger.sql
migration-017-pagamentos-plano-fixo.sql
```n
### 10 migrations mais recentes:
```n999_correcoes_criticas_seguranca.sql
999_fix_audit_laudo_trigger.sql
999_fix_audit_lote_and_status_security.sql
999_fix_contratos_numero_contrato.sql
999_fix_missing_audit_and_validator.sql
999_reserva_id_laudo_on_lote_insert.sql
migration-005-tokens-retomada.sql
migration-006-fix-ativa-default.sql
migration-007-fix-sync-trigger.sql
migration-017-pagamentos-plano-fixo.sql
```n

## 9. ANÁLISE DO TRIGGER trg_recalc_lote_on_avaliacao_change

### Definição em PRODUÇÃO:
```sql
 CREATE TRIGGER trg_recalc_lote_on_avaliacao_change AFTER INSERT OR DELETE OR UPDATE ON public.avaliacoes FOR EACH ROW EXECUTE FUNCTION fn_recalcular_status_lote_on_avaliacao_update()
```n
### Definição em DESENVOLVIMENTO:
```sql

```n
### Função fn_recalcular_status_lote_on_avaliacao_update em PRODUÇÃO:
```sql
 CREATE OR REPLACE FUNCTION public.fn_recalcular_status_lote_on_avaliacao_update()               +   RETURNS trigger                                                                                +   LANGUAGE plpgsql                                                                               +  AS $function$\r                                                                                 +  DECLARE\r                                                                                       +    v_liberadas int;\r                                                                            +    v_concluidas int;\r                                                                           +    v_inativadas int;\r                                                                           +    v_lote_id int;\r                                                                              +  BEGIN\r                                                                                         +    -- Determinar lote_id baseado na opera├º├úo\r                                                   +    IF TG_OP = 'DELETE' THEN\r                                                                    +      v_lote_id := OLD.lote_id;\r                                                                 +    ELSE\r                                                                                        +      v_lote_id := NEW.lote_id;\r                                                                 +    END IF;\r                                                                                     +  \r                                                                                              +    -- Para UPDATE, s├│ agir quando houve altera├º├úo de status\r                                    +    IF TG_OP = 'UPDATE' AND NEW.status IS NOT DISTINCT FROM OLD.status THEN\r                     +      RETURN NEW;\r                                                                               +    END IF;\r                                                                                     +  \r                                                                                              +    -- Calcular estat├¡sticas para o lote afetado\r                                                +    SELECT\r                                                                                      +      COUNT(*) FILTER (WHERE status != 'rascunho')::int,\r                                        +      COUNT(*) FILTER (WHERE status = 'concluida')::int,\r                                        +      COUNT(*) FILTER (WHERE status = 'inativada')::int\r                                         +    INTO v_liberadas, v_concluidas, v_inativadas\r                                                +    FROM avaliacoes\r                                                                             +    WHERE lote_id = v_lote_id;\r                                                                  +  \r                                                                                              +    -- Se condi├º├úo de conclus├úo for satisfeita, atualizar lote\r                                  +    IF v_liberadas > 0 AND v_concluidas > 0 AND (v_concluidas + v_inativadas) = v_liberadas THEN\r+      UPDATE lotes_avaliacao\r                                                                    +      SET status = 'concluido', atualizado_em = NOW()\r                                           +      WHERE id = v_lote_id AND status IS DISTINCT FROM 'concluido';\r                             +    ELSIF v_liberadas > 0 AND v_concluidas > 0 THEN\r                                             +      -- Se tem liberadas e conclu├¡das, mas ainda n├úo todas: em_andamento\r                       +      UPDATE lotes_avaliacao\r                                                                    +      SET status = 'em_andamento', atualizado_em = NOW()\r                                        +      WHERE id = v_lote_id AND status = 'liberado';\r                                             +    END IF;\r                                                                                     +  \r                                                                                              +    IF TG_OP = 'DELETE' THEN\r                                                                    +      RETURN OLD;\r                                                                               +    ELSE\r                                                                                        +      RETURN NEW;\r                                                                               +    END IF;\r                                                                                     +  END;\r                                                                                          +  $function$                                                                                      +
```n

## 10. RESUMO E AÇÕES RECOMENDADAS

### Problemas Identificados:

1. **Triggers Duplicados**: Produção tem triggers duplicados que podem causar loops
2. **Funções Ausentes em Dev**: 7 funções em produção não estão em desenvolvimento
3. **Views Ausentes em Dev**: 2 views em produção não estão em desenvolvimento
4. **Trigger Problemático**: trg_recalc_lote_on_avaliacao_change pode estar chamando função incorretamente

### Ações Imediatas Recomendadas:

1. **Remover triggers duplicados em produção**
   - Identificados: trg_recalc_lote_on_avaliacao_change (3x)
   - tr_tomadores_sync_status_ativa (2x)

2. **Sincronizar funções**:
   - Aplicar migrations ou criar funções faltantes em dev
   - Ou remover funções não utilizadas de prod

3. **Verificar endpoint parity**:
   - Garantir que RH e Entidade têm rotas equivalentes
   - Verificar autenticação e autorização

4. **Validar migrations**:
   - Criar sistema de tracking de migrations
   - Garantir aplicação sequencial

### Próximos Passos:

- [ ] Corrigir trigger trg_recalc_lote_on_avaliacao_change
- [ ] Remover duplicatas de triggers
- [ ] Sincronizar funções e views
- [ ] Implementar sistema de migration tracking
- [ ] Validar paridade de endpoints

````
